name: daily_user_stats
destination:
  dataset: analytics
  table: daily_user_stats
  partition:
    field: date
    type: DAY
  cluster:
    - region
    - user_tier

description: Daily aggregated user statistics
owner: data-team
tags: [analytics, users, daily]

versions:
  - version: 1
    effective_from: 2024-01-15
    source: ${{ file: daily_user_stats.v1.sql }}
    schema:
      - name: date
        type: DATE
      - name: region
        type: STRING
      - name: user_tier
        type: STRING
      - name: unique_users
        type: INT64
      - name: total_events
        type: INT64

  - version: 2
    effective_from: 2024-03-20
    description: Fixed join bug, schema unchanged
    source: ${{ file: daily_user_stats.v2.sql }}
    revisions:
      - revision: 1
        effective_from: 2024-04-10
        source: ${{ file: daily_user_stats.v2.r1.sql }}
        reason: Fixed null handling in join
        backfill_since: 2024-03-20
    schema: ${{ versions.1.schema }}

  - version: 3
    effective_from: 2024-06-01
    description: Added session duration metric
    source: ${{ file: daily_user_stats.v3.sql }}
    backfill_since: 2024-06-01
    schema:
      base: ${{ versions.2.schema }}
      add:
        - name: avg_session_duration
          type: FLOAT64
          nullable: true
